<!doctype html>
<html lang="zh-Hans">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>使用 Azure 机器学习对小型语言模型 Phi-3 进行微调 | Innovation with tech</title>
    <meta property="og:title" content="使用 Azure 机器学习对小型语言模型 Phi-3 进行微调 - Innovation with tech">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2024-06-07T12:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2024-06-07T12:00:00&#43;08:00'>
        
    <meta name="Keywords" content="C#,.Net,Python,Nodejs,Java,Golang,博客,软件架构,云原生,机器学习,数据分析,RPA,自动化,技术管理">
    <meta name="description" content="使用 Azure 机器学习对小型语言模型 Phi-3 进行微调">
    <meta name="author" content="">
    <meta property="og:url" content="https://beanhsiang.github.io/post/2024-06-07-finetune-small-language-model-phi-3-using-azure-machine/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
        <link href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" rel="stylesheet">
    
    
    
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://beanhsiang.github.io/">
                        Innovation with tech
                    </a>
                
                <p class="description">一个技术老兵工作的点滴记录，专注、沟通、乐在分享!</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://beanhsiang.github.io/">首页</a>
                    
                    <a  href="https://beanhsiang.github.io/tools/" title="工具">工具</a>
                    
                    <a  href="https://beanhsiang.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://beanhsiang.github.io/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">使用 Azure 机器学习对小型语言模型 Phi-3 进行微调</h1>
        </header>
        
  <time datetime="2024-06-07T04:00:00Z" class="post-meta meta-date dt-published">
    2024年6月7日
  </time>


<div class="post-meta meta-category">
  <span>&nbsp;|</span>
  
    <a href='/categories/Azure-AI' target="_blank">Azure AI</a>
  
</div>


        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">&nbsp;|
                <span id="busuanzi_value_page_pv"></span> <span>阅读</span>
            </span>
        </div>
        
        
        <div class="post-content">
            <p>Phi-3 是由微软研究团队开发的小型语言模型。在多个公开基准测试（例如在 MMLU 上 Phi-3 达到了69%的成绩）中，Phi-3 表现良好并且可以支持长达128k的上下文。Phi-3-mini 3.8B版于2024年4月末首次发布，而 Phi-3-small、Phi-3-medium 和 Phi-3-vision 于5月在微软 Build 大会上揭晓。</p>
<p>QLoRA 是一种高效的微调技术，它将预训练语言模型量化为4位，并附加了小型“低秩适配器”，这些适配器是可微调的。这使得在单个GPU上可以微调具有多达650亿参数的模型，QLoRA 的性能与全精度微调相媲美，并在语言任务上实现了最佳效果。</p>
<p>本文将展示如何使用 QLoRA 高效量化 LLMs 的 Flash Attention 进行微调。</p>
<h2 id="准备">准备</h2>
<p>先下载 ultrachat 数据集。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">datasets</span> <span style="color:#cf222e">import</span> load_dataset
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">random</span> <span style="color:#cf222e">import</span> randrange
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Load dataset from the hub</span>
</span></span><span style="display:flex;"><span>dataset <span style="color:#0550ae">=</span> load_dataset<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;HuggingFaceH4/ultrachat_200k&#34;</span><span style="color:#1f2328">,</span> split<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;train_sft[:2%]&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;dataset size: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>dataset<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span>dataset<span style="color:#1f2328">[</span>randrange<span style="color:#1f2328">(</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>dataset<span style="color:#1f2328">))])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从数据集中选取一个较短的版本来创建训练和测试示例。为了训练我们的模型，我们需要将结构化的示例转换为一系列通过指令描述的任务。我们定义了一个函数，它接受一个样本并返回一个以我们指定格式编写的字符串。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>dataset <span style="color:#0550ae">=</span> dataset<span style="color:#0550ae">.</span>train_test_split<span style="color:#1f2328">(</span>test_size<span style="color:#0550ae">=</span><span style="color:#0550ae">0.2</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>train_dataset <span style="color:#0550ae">=</span> dataset<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;train&#39;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>train_dataset<span style="color:#0550ae">.</span>to_json<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;data/train.jsonl&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>test_dataset <span style="color:#0550ae">=</span> dataset<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;test&#39;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>test_dataset<span style="color:#0550ae">.</span>to_json<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;data/eval.jsonl&#34;</span><span style="color:#1f2328">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>将训练数据集和测试数据集保存为JSON格式。现在添加 Azure ML SDK 声明。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a"># import required libraries</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">azure.identity</span> <span style="color:#cf222e">import</span> DefaultAzureCredential<span style="color:#1f2328">,</span> InteractiveBrowserCredential
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">azure.ai.ml</span> <span style="color:#cf222e">import</span> MLClient<span style="color:#1f2328">,</span> Input
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">azure.ai.ml.dsl</span> <span style="color:#cf222e">import</span> pipeline
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">azure.ai.ml</span> <span style="color:#cf222e">import</span> load_component
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">azure.ai.ml</span> <span style="color:#cf222e">import</span> command
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">azure.ai.ml.entities</span> <span style="color:#cf222e">import</span> Data
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">azure.ai.ml</span> <span style="color:#cf222e">import</span> Input
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">azure.ai.ml</span> <span style="color:#cf222e">import</span> Output
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">azure.ai.ml.constants</span> <span style="color:#cf222e">import</span> AssetTypes
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建工作空间客户端。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>credential <span style="color:#0550ae">=</span> DefaultAzureCredential<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>workspace_ml_client <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    workspace_ml_client <span style="color:#0550ae">=</span> MLClient<span style="color:#0550ae">.</span>from_config<span style="color:#1f2328">(</span>credential<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> ex<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span>ex<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    subscription_id<span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;Enter your subscription_id&#34;</span>
</span></span><span style="display:flex;"><span>    resource_group <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;Enter your resource_group&#34;</span>
</span></span><span style="display:flex;"><span>    workspace<span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;Enter your workspace name&#34;</span>
</span></span><span style="display:flex;"><span>    workspace_ml_client <span style="color:#0550ae">=</span> MLClient<span style="color:#1f2328">(</span>credential<span style="color:#1f2328">,</span> subscription_id<span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                                     resource_group<span style="color:#1f2328">,</span> workspace<span style="color:#1f2328">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建一个自定义的训练环境。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">azure.ai.ml.entities</span> <span style="color:#cf222e">import</span> Environment<span style="color:#1f2328">,</span> BuildContext
</span></span><span style="display:flex;"><span>env_docker_image <span style="color:#0550ae">=</span> Environment<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    image<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;mcr.microsoft.com/azureml/curated/acft-hf-nlp-gpu:latest&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    conda_file<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;environment/conda.yml&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;llm-training&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    description<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;Environment created for llm training.&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>workspace_ml_client<span style="color:#0550ae">.</span>environments<span style="color:#0550ae">.</span>create_or_update<span style="color:#1f2328">(</span>env_docker_image<span style="color:#1f2328">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>来检查一下这个 conda.yaml。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>model-env<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">channels</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span>- conda-forge<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">dependencies</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span>- python=3.8<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span>- pip=24.0<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span>- <span style="color:#0550ae">pip</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- bitsandbytes==0.43.1<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- transformers~=4.41<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- peft~=0.11<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- accelerate~=0.30<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- trl==0.8.6<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- einops==0.8.0<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- datasets==2.19.1<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- wandb==0.17.0<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- mlflow==2.13.0<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- azureml-mlflow==1.56.0 <span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- torchvision==0.18.0<span style="color:#fff">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="训练">训练</h2>
<p>我们将使用 Tim Dettmers 等人在论文“<a href="https://arxiv.org/abs/2305.14314">QLoRA: Quantization-aware Low-Rank Adapter Tuning for Language Generation</a>”中提出的新方法。QLoRA 是一种在微调大型语言模型时减少内存占用的新技术，同时不会降低性能。</p>
<p>QLoRA的工作原理概述如下：</p>
<ul>
<li>将预训练模型量化为4位精度并冻结其参数。</li>
<li>添加小型、可训练的适配层（LoRA）。</li>
<li>仅微调适配层，同时使用冻结的量化模型来获取上下文信息。</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">164
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">165
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">166
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">167
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">168
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">169
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">170
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">171
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">172
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">173
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">174
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">175
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">176
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">177
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">178
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">179
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">180
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">181
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">182
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">183
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">184
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">185
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">186
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">187
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">188
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">189
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">190
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">191
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">192
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">193
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">194
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">195
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">196
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">197
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">198
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">199
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">200
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">201
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">202
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">203
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">204
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">205
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">206
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">207
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">208
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">209
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">210
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">211
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">212
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">213
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">214
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">215
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">216
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">217
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">218
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">219
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">os</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">#import mlflow</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">argparse</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">sys</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">logging</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">datasets</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">datasets</span> <span style="color:#cf222e">import</span> load_dataset
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">peft</span> <span style="color:#cf222e">import</span> LoraConfig
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">torch</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">transformers</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">trl</span> <span style="color:#cf222e">import</span> SFTTrainer
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">transformers</span> <span style="color:#cf222e">import</span> AutoModelForCausalLM<span style="color:#1f2328">,</span> AutoTokenizer<span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                         TrainingArguments<span style="color:#1f2328">,</span> BitsAndBytesConfig
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">datasets</span> <span style="color:#cf222e">import</span> load_dataset
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>logger <span style="color:#0550ae">=</span> logging<span style="color:#0550ae">.</span>getLogger<span style="color:#1f2328">(</span><span style="color:#953800">__name__</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">###################</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Hyper-parameters</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">###################</span>
</span></span><span style="display:flex;"><span>training_config <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;bf16&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">True</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;do_eval&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">False</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;learning_rate&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">5.0e-06</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;log_level&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;info&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;logging_steps&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">20</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;logging_strategy&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;steps&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;lr_scheduler_type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;cosine&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;num_train_epochs&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;max_steps&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;output_dir&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;./checkpoint_dir&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;overwrite_output_dir&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">True</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;per_device_eval_batch_size&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">4</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;per_device_train_batch_size&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">4</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;remove_unused_columns&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">True</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;save_steps&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">100</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;save_total_limit&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;seed&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;gradient_checkpointing&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">True</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;gradient_checkpointing_kwargs&#34;</span><span style="color:#1f2328">:{</span><span style="color:#0a3069">&#34;use_reentrant&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">False</span><span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;gradient_accumulation_steps&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;warmup_ratio&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">0.2</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>peft_config <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;r&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">16</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;lora_alpha&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">32</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;lora_dropout&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">0.05</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;bias&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;none&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;task_type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;CAUSAL_LM&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;target_modules&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;all-linear&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;modules_to_save&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>train_conf <span style="color:#0550ae">=</span> TrainingArguments<span style="color:#1f2328">(</span><span style="color:#0550ae">**</span>training_config<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>peft_conf <span style="color:#0550ae">=</span> LoraConfig<span style="color:#1f2328">(</span><span style="color:#0550ae">**</span>peft_config<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">###############</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Setup logging</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">###############</span>
</span></span><span style="display:flex;"><span>logging<span style="color:#0550ae">.</span>basicConfig<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">format</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">%(asctime)s</span><span style="color:#0a3069"> - </span><span style="color:#0a3069">%(levelname)s</span><span style="color:#0a3069"> - </span><span style="color:#0a3069">%(name)s</span><span style="color:#0a3069"> - </span><span style="color:#0a3069">%(message)s</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    datefmt<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;%Y-%m-</span><span style="color:#0a3069">%d</span><span style="color:#0a3069"> %H:%M:%S&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    handlers<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span>logging<span style="color:#0550ae">.</span>StreamHandler<span style="color:#1f2328">(</span>sys<span style="color:#0550ae">.</span>stdout<span style="color:#1f2328">)],</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>log_level <span style="color:#0550ae">=</span> train_conf<span style="color:#0550ae">.</span>get_process_log_level<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>logger<span style="color:#0550ae">.</span>setLevel<span style="color:#1f2328">(</span>log_level<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>datasets<span style="color:#0550ae">.</span>utils<span style="color:#0550ae">.</span>logging<span style="color:#0550ae">.</span>set_verbosity<span style="color:#1f2328">(</span>log_level<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>transformers<span style="color:#0550ae">.</span>utils<span style="color:#0550ae">.</span>logging<span style="color:#0550ae">.</span>set_verbosity<span style="color:#1f2328">(</span>log_level<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>transformers<span style="color:#0550ae">.</span>utils<span style="color:#0550ae">.</span>logging<span style="color:#0550ae">.</span>enable_default_handler<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>transformers<span style="color:#0550ae">.</span>utils<span style="color:#0550ae">.</span>logging<span style="color:#0550ae">.</span>enable_explicit_format<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Log on each process a small summary</span>
</span></span><span style="display:flex;"><span>logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Process rank: </span><span style="color:#0a3069">{</span>train_conf<span style="color:#0550ae">.</span>local_rank<span style="color:#0a3069">}</span><span style="color:#0a3069">, </span>
</span></span><span style="display:flex;"><span>    device<span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>train_conf<span style="color:#0550ae">.</span>device<span style="color:#1f2328">},</span> n_gpu<span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>train_conf<span style="color:#0550ae">.</span>n_gpu<span style="color:#1f2328">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">+</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34; distributed training: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">bool</span><span style="color:#1f2328">(</span>train_conf<span style="color:#0550ae">.</span>local_rank <span style="color:#0550ae">!=</span> <span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">, </span>
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">16</span><span style="color:#0550ae">-</span>bits training<span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>train_conf<span style="color:#0550ae">.</span>fp16<span style="color:#1f2328">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Training/evaluation parameters </span><span style="color:#0a3069">{</span>train_conf<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;PEFT parameters </span><span style="color:#0a3069">{</span>peft_conf<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">################</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Modle Loading</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">################</span>
</span></span><span style="display:flex;"><span>checkpoint_path <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;microsoft/Phi-3-mini-4k-instruct&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># checkpoint_path = &#34;microsoft/Phi-3-mini-128k-instruct&#34;</span>
</span></span><span style="display:flex;"><span>model_kwargs <span style="color:#0550ae">=</span> <span style="color:#6639ba">dict</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    use_cache<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    trust_remote_code<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># loading the model with flash-attenstion support</span>
</span></span><span style="display:flex;"><span>    attn_implementation<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;flash_attention_2&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    torch_dtype<span style="color:#0550ae">=</span>torch<span style="color:#0550ae">.</span>bfloat16<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    device_map<span style="color:#0550ae">=</span><span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>model <span style="color:#0550ae">=</span> AutoModelForCausalLM<span style="color:#0550ae">.</span>from_pretrained<span style="color:#1f2328">(</span>checkpoint_path<span style="color:#1f2328">,</span> <span style="color:#0550ae">**</span>model_kwargs<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>tokenizer <span style="color:#0550ae">=</span> AutoTokenizer<span style="color:#0550ae">.</span>from_pretrained<span style="color:#1f2328">(</span>checkpoint_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>tokenizer<span style="color:#0550ae">.</span>model_max_length <span style="color:#0550ae">=</span> <span style="color:#0550ae">2048</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># use unk rather than eos token to prevent endless generation</span>
</span></span><span style="display:flex;"><span>tokenizer<span style="color:#0550ae">.</span>pad_token <span style="color:#0550ae">=</span> tokenizer<span style="color:#0550ae">.</span>unk_token
</span></span><span style="display:flex;"><span>tokenizer<span style="color:#0550ae">.</span>pad_token_id <span style="color:#0550ae">=</span> tokenizer<span style="color:#0550ae">.</span>convert_tokens_to_ids<span style="color:#1f2328">(</span>tokenizer<span style="color:#0550ae">.</span>pad_token<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>tokenizer<span style="color:#0550ae">.</span>padding_side <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;right&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">##################</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Data Processing</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">##################</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">apply_chat_template</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    example<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    tokenizer<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    messages <span style="color:#0550ae">=</span> example<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Add an empty system message if there is none</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> messages<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">][</span><span style="color:#0a3069">&#34;role&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">!=</span> <span style="color:#0a3069">&#34;system&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        messages<span style="color:#0550ae">.</span>insert<span style="color:#1f2328">(</span><span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;role&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;system&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;content&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>    example<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;text&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> tokenizer<span style="color:#0550ae">.</span>apply_chat_template<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        messages<span style="color:#1f2328">,</span> tokenize<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">,</span> add_generation_prompt<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">main</span><span style="color:#1f2328">(</span>args<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    train_dataset <span style="color:#0550ae">=</span> load_dataset<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;json&#39;</span><span style="color:#1f2328">,</span> data_files<span style="color:#0550ae">=</span>args<span style="color:#0550ae">.</span>train_file<span style="color:#1f2328">,</span> split<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;train&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    test_dataset <span style="color:#0550ae">=</span> load_dataset<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;json&#39;</span><span style="color:#1f2328">,</span> data_files<span style="color:#0550ae">=</span>args<span style="color:#0550ae">.</span>eval_file<span style="color:#1f2328">,</span> split<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;train&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    column_names <span style="color:#0550ae">=</span> <span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>train_dataset<span style="color:#0550ae">.</span>features<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    processed_train_dataset <span style="color:#0550ae">=</span> train_dataset<span style="color:#0550ae">.</span>map<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        apply_chat_template<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        fn_kwargs<span style="color:#0550ae">=</span><span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;tokenizer&#34;</span><span style="color:#1f2328">:</span> tokenizer<span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>        num_proc<span style="color:#0550ae">=</span><span style="color:#0550ae">10</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        remove_columns<span style="color:#0550ae">=</span>column_names<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        desc<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;Applying chat template to train_sft&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    processed_test_dataset <span style="color:#0550ae">=</span> test_dataset<span style="color:#0550ae">.</span>map<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        apply_chat_template<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        fn_kwargs<span style="color:#0550ae">=</span><span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;tokenizer&#34;</span><span style="color:#1f2328">:</span> tokenizer<span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>        num_proc<span style="color:#0550ae">=</span><span style="color:#0550ae">10</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        remove_columns<span style="color:#0550ae">=</span>column_names<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        desc<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;Applying chat template to test_sft&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">###########</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Training</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">###########</span>
</span></span><span style="display:flex;"><span>    trainer <span style="color:#0550ae">=</span> SFTTrainer<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        model<span style="color:#0550ae">=</span>model<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        args<span style="color:#0550ae">=</span>train_conf<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        peft_config<span style="color:#0550ae">=</span>peft_conf<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        train_dataset<span style="color:#0550ae">=</span>processed_train_dataset<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        eval_dataset<span style="color:#0550ae">=</span>processed_test_dataset<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        max_seq_length<span style="color:#0550ae">=</span><span style="color:#0550ae">2048</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        dataset_text_field<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;text&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        tokenizer<span style="color:#0550ae">=</span>tokenizer<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        packing<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    train_result <span style="color:#0550ae">=</span> trainer<span style="color:#0550ae">.</span>train<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    metrics <span style="color:#0550ae">=</span> train_result<span style="color:#0550ae">.</span>metrics
</span></span><span style="display:flex;"><span>    trainer<span style="color:#0550ae">.</span>log_metrics<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;train&#34;</span><span style="color:#1f2328">,</span> metrics<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    trainer<span style="color:#0550ae">.</span>save_metrics<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;train&#34;</span><span style="color:#1f2328">,</span> metrics<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    trainer<span style="color:#0550ae">.</span>save_state<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">#############</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Evaluation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">#############</span>
</span></span><span style="display:flex;"><span>    tokenizer<span style="color:#0550ae">.</span>padding_side <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;left&#39;</span>
</span></span><span style="display:flex;"><span>    metrics <span style="color:#0550ae">=</span> trainer<span style="color:#0550ae">.</span>evaluate<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    metrics<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;eval_samples&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>processed_test_dataset<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    trainer<span style="color:#0550ae">.</span>log_metrics<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;eval&#34;</span><span style="color:#1f2328">,</span> metrics<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    trainer<span style="color:#0550ae">.</span>save_metrics<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;eval&#34;</span><span style="color:#1f2328">,</span> metrics<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># ############</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># # Save model</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># ############</span>
</span></span><span style="display:flex;"><span>    os<span style="color:#0550ae">.</span>makedirs<span style="color:#1f2328">(</span>args<span style="color:#0550ae">.</span>model_dir<span style="color:#1f2328">,</span> exist_ok<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    torch<span style="color:#0550ae">.</span>save<span style="color:#1f2328">(</span>model<span style="color:#1f2328">,</span> os<span style="color:#0550ae">.</span>path<span style="color:#0550ae">.</span>join<span style="color:#1f2328">(</span>args<span style="color:#0550ae">.</span>model_dir<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;model.pt&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">parse_args</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># setup argparse</span>
</span></span><span style="display:flex;"><span>    parser <span style="color:#0550ae">=</span> argparse<span style="color:#0550ae">.</span>ArgumentParser<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># add arguments</span>
</span></span><span style="display:flex;"><span>    parser<span style="color:#0550ae">.</span>add_argument<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;--train-file&#34;</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">type</span><span style="color:#0550ae">=</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> help<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;Input data for training&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    parser<span style="color:#0550ae">.</span>add_argument<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;--eval-file&#34;</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">type</span><span style="color:#0550ae">=</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> help<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;Input data for eval&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    parser<span style="color:#0550ae">.</span>add_argument<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;--model-dir&#34;</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">type</span><span style="color:#0550ae">=</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> default<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;./&#34;</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>    help<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;output directory for model&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    parser<span style="color:#0550ae">.</span>add_argument<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;--epochs&#34;</span><span style="color:#1f2328">,</span> default<span style="color:#0550ae">=</span><span style="color:#0550ae">10</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">type</span><span style="color:#0550ae">=</span><span style="color:#6639ba">int</span><span style="color:#1f2328">,</span> help<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;number of epochs&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    parser<span style="color:#0550ae">.</span>add_argument<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;--batch-size&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        default<span style="color:#0550ae">=</span><span style="color:#0550ae">16</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">type</span><span style="color:#0550ae">=</span><span style="color:#6639ba">int</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        help<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;mini batch size for each gpu/process&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    parser<span style="color:#0550ae">.</span>add_argument<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;--learning-rate&#34;</span><span style="color:#1f2328">,</span> default<span style="color:#0550ae">=</span><span style="color:#0550ae">0.001</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">type</span><span style="color:#0550ae">=</span><span style="color:#6639ba">float</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>    help<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;learning rate&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    parser<span style="color:#0550ae">.</span>add_argument<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;--momentum&#34;</span><span style="color:#1f2328">,</span> default<span style="color:#0550ae">=</span><span style="color:#0550ae">0.9</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">type</span><span style="color:#0550ae">=</span><span style="color:#6639ba">float</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>    help<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;momentum&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    parser<span style="color:#0550ae">.</span>add_argument<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;--print-freq&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        default<span style="color:#0550ae">=</span><span style="color:#0550ae">200</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">type</span><span style="color:#0550ae">=</span><span style="color:#6639ba">int</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        help<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;frequency of printing training statistics&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># parse args</span>
</span></span><span style="display:flex;"><span>    args <span style="color:#0550ae">=</span> parser<span style="color:#0550ae">.</span>parse_args<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># return args</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> args
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># run script</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">if</span> <span style="color:#953800">__name__</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;__main__&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># parse args</span>
</span></span><span style="display:flex;"><span>    args <span style="color:#0550ae">=</span> parse_args<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># call main function</span>
</span></span><span style="display:flex;"><span>    main<span style="color:#1f2328">(</span>args<span style="color:#1f2328">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建一个训练计算的实例。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">azure.ai.ml.entities</span> <span style="color:#cf222e">import</span> AmlCompute
</span></span><span style="display:flex;"><span><span style="color:#57606a"># If you have a specific compute size to work with change it here. </span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># By default we use the 1 x A100 compute from the above list</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>compute_cluster_size <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;Standard_NC24ads_A100_v4&#34;</span>  <span style="color:#57606a"># 1 x A100 (80GB)</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># If you already have a gpu cluster, mention it here. </span>
</span></span><span style="display:flex;"><span>Else will create a new one <span style="color:#cf222e">with</span> the name <span style="color:#0a3069">&#39;gpu-cluster-big&#39;</span>
</span></span><span style="display:flex;"><span>compute_cluster <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;gpu-a100&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    compute <span style="color:#0550ae">=</span> ml_client<span style="color:#0550ae">.</span>compute<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span>compute_cluster<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;The compute cluster already exists! Reusing it for the current run&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> ex<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Looks like the compute cluster doesn&#39;t exist. Creating a new one </span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">with</span> compute size <span style="color:#1f2328">{</span>compute_cluster_size<span style="color:#1f2328">}</span><span style="color:#f6f8fa;background-color:#82071e">!</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Attempt #1 - Trying to create a dedicated compute&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        compute <span style="color:#0550ae">=</span> AmlCompute<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            name<span style="color:#0550ae">=</span>compute_cluster<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            size<span style="color:#0550ae">=</span>compute_cluster_size<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            tier<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;Dedicated&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># For multi node training set this to an integer value more than 1</span>
</span></span><span style="display:flex;"><span>            max_instances<span style="color:#0550ae">=</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        ml_client<span style="color:#0550ae">.</span>compute<span style="color:#0550ae">.</span>begin_create_or_update<span style="color:#1f2328">(</span>compute<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>wait<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Error&#34;</span><span style="color:#1f2328">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>以下是一些有用的建议:</p>
<ul>
<li>不需要使用较高的LoRA编码级别（例如，r=256）。根据经验8或16的编码级别就足以作为基础了。</li>
<li>如果训练数据集较小，最好将rank设置为alpha。通常对于较小的数据集，2* rank或4* rank的训练通常不稳定。</li>
<li>在使用LORA时，将学习率设置为较小的值。例如1e-3或2e-4的学习率是不推荐的。建议从8e-4或5e-5开始尝试。</li>
<li>与其增大批处理大小，你应该检查是否有足够的 GPU 内存。这是因为如果上下文长度为8K等较长时，可能会出现OOM（内存不足）情况。使用梯度检查点和梯度累积可以增加批处理大小的效果。</li>
<li>如果你对批量大小和内存敏感，那么绝对不要使用Adam，包括低精度Adam。Adam需要额外的GPU内存来计算动量。SGD（随机梯度下降）的收敛速度较慢，但不会占用额外的GPU内存。</li>
</ul>
<p>现在使用刚才创建的 AML 计算来运行上述训练脚本。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">azure.ai.ml</span> <span style="color:#cf222e">import</span> command
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">azure.ai.ml</span> <span style="color:#cf222e">import</span> Input
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">azure.ai.ml.entities</span> <span style="color:#cf222e">import</span> ResourceConfiguration
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>job <span style="color:#0550ae">=</span> command<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    inputs<span style="color:#0550ae">=</span><span style="color:#6639ba">dict</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        train_file<span style="color:#0550ae">=</span>Input<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">type</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;uri_file&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            path<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;data/train.jsonl&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        eval_file<span style="color:#0550ae">=</span>Input<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">type</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;uri_file&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            path<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;data/eval.jsonl&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">),</span>        
</span></span><span style="display:flex;"><span>        epoch<span style="color:#0550ae">=</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        batchsize<span style="color:#0550ae">=</span><span style="color:#0550ae">64</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        lr <span style="color:#0550ae">=</span> <span style="color:#0550ae">0.01</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        momentum <span style="color:#0550ae">=</span> <span style="color:#0550ae">0.9</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        prtfreq <span style="color:#0550ae">=</span> <span style="color:#0550ae">200</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        output <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;./outputs&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    code<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;./src&#34;</span><span style="color:#1f2328">,</span>  <span style="color:#57606a"># local path where the code is stored</span>
</span></span><span style="display:flex;"><span>    compute <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;gpu-a100&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    command<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;&#34;&#34;accelerate launch train.py --train-file ${{inputs.train_file}} 
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    --eval-file ${{inputs.eval_file}} --epochs ${{inputs.epoch}} 
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    --batch-size ${{inputs.batchsize}} --learning-rate ${{inputs.lr}} 
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    --momentum ${{inputs.momentum}} --print-freq ${{inputs.prtfreq}} 
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    --model-dir ${{inputs.output}}&#34;&#34;&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    environment<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;azureml://registries/azureml/environments/acft-hf-nlp-gpu/versions/52&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    distribution<span style="color:#0550ae">=</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;PyTorch&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;process_count_per_instance&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>returned_job  <span style="color:#0550ae">=</span> workspace_ml_client<span style="color:#0550ae">.</span>jobs<span style="color:#0550ae">.</span>create_or_update<span style="color:#1f2328">(</span>job<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>workspace_ml_client<span style="color:#0550ae">.</span>jobs<span style="color:#0550ae">.</span>stream<span style="color:#1f2328">(</span>returned_job<span style="color:#0550ae">.</span>name<span style="color:#1f2328">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>输出管道的结果。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a"># check if the `trained_model` output is available</span>
</span></span><span style="display:flex;"><span>job_name <span style="color:#0550ae">=</span> returned_job<span style="color:#0550ae">.</span>name
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;pipeline job outputs: &#34;</span><span style="color:#1f2328">,</span> workspace_ml_client<span style="color:#0550ae">.</span>jobs<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span>job_name<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="收尾">收尾</h2>
<p>一旦模型完成微调，请在工作空间中注册该工作以创建端点。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">azure.ai.ml.entities</span> <span style="color:#cf222e">import</span> Model
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">azure.ai.ml.constants</span> <span style="color:#cf222e">import</span> AssetTypes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>run_model <span style="color:#0550ae">=</span> Model<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    path<span style="color:#0550ae">=</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;azureml://jobs/</span><span style="color:#0a3069">{</span>job_name<span style="color:#0a3069">}</span><span style="color:#0a3069">/outputs/artifacts/paths/outputs/mlflow_model_folder&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;phi-3-finetuned&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    description<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;Model created from run.&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">type</span><span style="color:#0550ae">=</span>AssetTypes<span style="color:#0550ae">.</span>MLFLOW_MODEL<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>model <span style="color:#0550ae">=</span> workspace_ml_client<span style="color:#0550ae">.</span>models<span style="color:#0550ae">.</span>create_or_update<span style="color:#1f2328">(</span>run_model<span style="color:#1f2328">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>此时创建一个端点。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">azure.ai.ml.entities</span> <span style="color:#cf222e">import</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    ManagedOnlineEndpoint<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    IdentityConfiguration<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    ManagedIdentityConfiguration<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Check if the endpoint already exists in the workspace</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    endpoint <span style="color:#0550ae">=</span> workspace_ml_client<span style="color:#0550ae">.</span>online_endpoints<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span>endpoint_name<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;---Endpoint already exists---&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">except</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Create an online endpoint if it doesn&#39;t exist</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Define the endpoint</span>
</span></span><span style="display:flex;"><span>    endpoint <span style="color:#0550ae">=</span> ManagedOnlineEndpoint<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        name<span style="color:#0550ae">=</span>endpoint_name<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        description<span style="color:#0550ae">=</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Test endpoint for </span><span style="color:#0a3069">{</span>model<span style="color:#0550ae">.</span>name<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        identity<span style="color:#0550ae">=</span>IdentityConfiguration<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">type</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;user_assigned&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            user_assigned_identities<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span>ManagedIdentityConfiguration<span style="color:#1f2328">(</span>resource_id<span style="color:#0550ae">=</span>uai_id<span style="color:#1f2328">)],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> uai_id <span style="color:#0550ae">!=</span> <span style="color:#0a3069">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">else</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Trigger the endpoint creation</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    workspace_ml_client<span style="color:#0550ae">.</span>begin_create_or_update<span style="color:#1f2328">(</span>endpoint<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>wait<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">---Endpoint created successfully---</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> err<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">raise</span> RuntimeError<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Endpoint creation failed. Detailed Response:</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">{</span>err<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span> <span style="color:#cf222e">from</span> <span style="color:#24292e">err</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>一旦创建了端点就可以继续创建部署了。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a"># Initialize deployment parameters</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deployment_name <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;phi3-deploy&#34;</span>
</span></span><span style="display:flex;"><span>sku_name <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;Standard_NCs_v3&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>REQUEST_TIMEOUT_MS <span style="color:#0550ae">=</span> <span style="color:#0550ae">90000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deployment_env_vars <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;SUBSCRIPTION_ID&#34;</span><span style="color:#1f2328">:</span> subscription_id<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;RESOURCE_GROUP_NAME&#34;</span><span style="color:#1f2328">:</span> resource_group<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;UAI_CLIENT_ID&#34;</span><span style="color:#1f2328">:</span> uai_client_id<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于推理，要使用不同的基础图像。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">azure.ai.ml.entities</span> <span style="color:#cf222e">import</span> Model<span style="color:#1f2328">,</span> Environment
</span></span><span style="display:flex;"><span>env <span style="color:#0550ae">=</span> Environment<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    image<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;mcr.microsoft.com/azureml/curated/foundation-model-inference:latest&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    inference_config<span style="color:#0550ae">=</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;liveness_route&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;port&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">5001</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;path&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;/&#34;</span><span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;readiness_route&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;port&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">5001</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;path&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;/&#34;</span><span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;scoring_route&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;port&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">5001</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;path&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;/score&#34;</span><span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在尝试部署这个模型。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">azure.ai.ml.entities</span> <span style="color:#cf222e">import</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    OnlineRequestSettings<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    CodeConfiguration<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    ManagedOnlineDeployment<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    ProbeSettings<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    Environment
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deployment <span style="color:#0550ae">=</span> ManagedOnlineDeployment<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    name<span style="color:#0550ae">=</span>deployment_name<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    endpoint_name<span style="color:#0550ae">=</span>endpoint_name<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    model<span style="color:#0550ae">=</span>model<span style="color:#0550ae">.</span>id<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    instance_type<span style="color:#0550ae">=</span>sku_name<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    instance_count<span style="color:#0550ae">=</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">#code_configuration=code_configuration,</span>
</span></span><span style="display:flex;"><span>    environment <span style="color:#0550ae">=</span> env<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    environment_variables<span style="color:#0550ae">=</span>deployment_env_vars<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    request_settings<span style="color:#0550ae">=</span>OnlineRequestSettings<span style="color:#1f2328">(</span>request_timeout_ms<span style="color:#0550ae">=</span>REQUEST_TIMEOUT_MS<span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    liveness_probe<span style="color:#0550ae">=</span>ProbeSettings<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        failure_threshold<span style="color:#0550ae">=</span><span style="color:#0550ae">30</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        success_threshold<span style="color:#0550ae">=</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        period<span style="color:#0550ae">=</span><span style="color:#0550ae">100</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        initial_delay<span style="color:#0550ae">=</span><span style="color:#0550ae">500</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    readiness_probe<span style="color:#0550ae">=</span>ProbeSettings<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        failure_threshold<span style="color:#0550ae">=</span><span style="color:#0550ae">30</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        success_threshold<span style="color:#0550ae">=</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        period<span style="color:#0550ae">=</span><span style="color:#0550ae">100</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        initial_delay<span style="color:#0550ae">=</span><span style="color:#0550ae">500</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Trigger the deployment creation</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    workspace_ml_client<span style="color:#0550ae">.</span>begin_create_or_update<span style="color:#1f2328">(</span>deployment<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>wait<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">---Deployment created successfully---</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> err<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">raise</span> RuntimeError<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Deployment creation failed. Detailed Response:</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">{</span>err<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span> <span style="color:#cf222e">from</span> <span style="color:#24292e">err</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果想删除该端点，请查看以下代码。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>workspace_ml_client<span style="color:#0550ae">.</span>online_deployments<span style="color:#0550ae">.</span>begin_delete<span style="color:#1f2328">(</span>name <span style="color:#0550ae">=</span> deployment_name<span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                                                    endpoint_name <span style="color:#0550ae">=</span> endpoint_name<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>workspace_ml_client<span style="color:#0550ae">.</span>_online_endpoints<span style="color:#0550ae">.</span>begin_delete<span style="color:#1f2328">(</span>name <span style="color:#0550ae">=</span> endpoint_name<span style="color:#1f2328">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>您可以对上面的代码片段进行实际操作，但如果您想对更完善的代码进行实际操作，请参阅 <a href="https://github.com/Azure/azure-llm-fine-tuning">GitHub azure-llm-fine-tuning 存储库</a>。</p>
<h2 id="参考来源">参考来源</h2>
<ul>
<li><a href="https://github.com/microsoft/Phi-3CookBook">https://github.com/microsoft/Phi-3CookBook</a></li>
<li><a href="https://www.microsoft.com/en-us/research/blog/phi-2-the-surprising-power-of-small-language-models/">https://www.microsoft.com/en-us/research/blog/phi-2-the-surprising-power-of-small-language-models/</a></li>
<li><a href="https://www.philschmid.de/sagemaker-falcon-180b-qlora">https://www.philschmid.de/sagemaker-falcon-180b-qlora</a></li>
<li><a href="https://github.com/daekeun-ml/azure-llm-fine-tuning">https://github.com/daekeun-ml/azure-llm-fine-tuning</a></li>
</ul>

        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="https://beanhsiang.github.io/">BeanHsiang</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="https://beanhsiang.github.io/post/2024-06-07-finetune-small-language-model-phi-3-using-azure-machine/">https://beanhsiang.github.io/post/2024-06-07-finetune-small-language-model-phi-3-using-azure-machine/</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>. 进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
    </ul>
</div>
<br/>



        


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/Azure-Machine-Learning' target="_blank">Azure Machine Learning</a></li>
                
                <li><a href='/tags/Phi-3' target="_blank">Phi-3</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "BeanHsiang/Greedy"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
    
    

</div>

                    <footer id="footer">
    <div>
        &copy; 2025 <a href="https://beanhsiang.github.io/">Innovation with tech By BeanHsiang</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>

<style type="text/css">
div.highlight {
    position: relative;
    margin: 1em 0px;
}

.copy-code {
    display: none;
    position: absolute;
    top: 4px;
    right: 4px;
    color: rgba(255, 255, 255, 0.8);
    background: rgba(78, 78, 78, 0.8);
    border-radius: var(--radius);
    padding: 0 5px;
    font: inherit;
    user-select: none;
    cursor: pointer;
    border: 0;
    --radius: 8px;
}

div.highlight:hover .copy-code,pre:hover .copy-code {
    display: block;
}

</style>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>


    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://beanhsiang.github.io/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://beanhsiang.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>

    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://beanhsiang.github.io/post/2025-05-12-updating-our-beliefs/" title="[译]基于模型的机器学习 - 1.2 更新我们的可信部分" target="_blank">[译]基于模型的机器学习 - 1.2 更新我们的可信部分</a>
    </li>
    
    <li>
        <a href="https://beanhsiang.github.io/post/2025-05-08-a-technical-deep-dive-into-orchestrating-ai-agents-using-semantic-kernel-plugins/" title="使用 Semantic Kernel 插件编排 AI 代理的技术深度解析" target="_blank">使用 Semantic Kernel 插件编排 AI 代理的技术深度解析</a>
    </li>
    
    <li>
        <a href="https://beanhsiang.github.io/post/2025-04-28-mbml-murder-mystery_incorporating_evidence/" title="[译]基于模型的机器学习 - 1.1 整合证据" target="_blank">[译]基于模型的机器学习 - 1.1 整合证据</a>
    </li>
    
    <li>
        <a href="https://beanhsiang.github.io/post/2025-04-24-using-pydanticai-for-agentic-development/" title="使用 PydanticAI 构建智能代理系统：从 MCP 到智能工单助手" target="_blank">使用 PydanticAI 构建智能代理系统：从 MCP 到智能工单助手</a>
    </li>
    
    <li>
        <a href="https://beanhsiang.github.io/post/2025-04-22-mbml-murder-mystery/" title="[译]基于模型的机器学习 - 第一章 谋杀之谜" target="_blank">[译]基于模型的机器学习 - 第一章 谋杀之谜</a>
    </li>
    
    <li>
        <a href="https://beanhsiang.github.io/post/2025-04-21-mbml-introduction/" title="[译]基于模型的机器学习 - 如何用机器学习解决我的问题？" target="_blank">[译]基于模型的机器学习 - 如何用机器学习解决我的问题？</a>
    </li>
    
    <li>
        <a href="https://beanhsiang.github.io/post/2025-04-20-mbml-preface/" title="[译]基于模型的机器学习 - 前言" target="_blank">[译]基于模型的机器学习 - 前言</a>
    </li>
    
    <li>
        <a href="https://beanhsiang.github.io/post/2025-04-20-mbml-table-of-contents/" title="[译]基于模型的机器学习 - 目录" target="_blank">[译]基于模型的机器学习 - 目录</a>
    </li>
    
    <li>
        <a href="https://beanhsiang.github.io/post/2025-04-18-google-a2a-protocol-integrated-using-semantic-kernel-python/" title="使用 Semantic Kernel Python 集成 Google A2A协议" target="_blank">使用 Semantic Kernel Python 集成 Google A2A协议</a>
    </li>
    
    <li>
        <a href="https://beanhsiang.github.io/post/2025-04-14-use-typescript-to-build-an-mcp-server-for-azure-ai-agent/" title="使用 TypeScript 构建 Azure AI Agent 的 MCP 服务器" target="_blank">使用 TypeScript 构建 Azure AI Agent 的 MCP 服务器</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://beanhsiang.github.io/categories/Azure-AI/">Azure AI (30)</a></li>
    
    <li><a href="https://beanhsiang.github.io/categories/FireUG/">FireUG (5)</a></li>
    
    <li><a href="https://beanhsiang.github.io/categories/GitHub-Copilot/">GitHub Copilot (2)</a></li>
    
    <li><a href="https://beanhsiang.github.io/categories/ML.NET/">ML.NET (8)</a></li>
    
    <li><a href="https://beanhsiang.github.io/categories/Model-Based-Machine-Learning/">Model-Based Machine Learning (6)</a></li>
    
    <li><a href="https://beanhsiang.github.io/categories/%E7%A9%BF%E8%B6%8A%E4%BA%BA%E6%9C%BA%E8%9E%8D%E5%90%88%E4%B9%8B%E9%99%85/">穿越人机融合之际 (5)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://beanhsiang.github.io/tags/.NET/">.NET</a>
    
    <a href="https://beanhsiang.github.io/tags/A2A/">A2A</a>
    
    <a href="https://beanhsiang.github.io/tags/Agentic-AI/">Agentic AI</a>
    
    <a href="https://beanhsiang.github.io/tags/Azure-AI/">Azure AI</a>
    
    <a href="https://beanhsiang.github.io/tags/Azure-AI-Agent/">Azure AI Agent</a>
    
    <a href="https://beanhsiang.github.io/tags/Azure-AI-Search/">Azure AI Search</a>
    
    <a href="https://beanhsiang.github.io/tags/Azure-Machine-Learning/">Azure Machine Learning</a>
    
    <a href="https://beanhsiang.github.io/tags/Azure-OpenAI/">Azure OpenAI</a>
    
    <a href="https://beanhsiang.github.io/tags/Azure-Speech/">Azure Speech</a>
    
    <a href="https://beanhsiang.github.io/tags/CSnakes/">CSnakes</a>
    
    <a href="https://beanhsiang.github.io/tags/FireUG/">FireUG</a>
    
    <a href="https://beanhsiang.github.io/tags/GitHub-Copilot/">GitHub Copilot</a>
    
    <a href="https://beanhsiang.github.io/tags/GPT-4o/">GPT-4o</a>
    
    <a href="https://beanhsiang.github.io/tags/GPT-4o-Realtime-Preview/">GPT-4o Realtime Preview</a>
    
    <a href="https://beanhsiang.github.io/tags/Machine-Learning/">Machine Learning</a>
    
    <a href="https://beanhsiang.github.io/tags/Magentic-One/">Magentic-One</a>
    
    <a href="https://beanhsiang.github.io/tags/MarkItDown/">MarkItDown</a>
    
    <a href="https://beanhsiang.github.io/tags/MCP/">MCP</a>
    
    <a href="https://beanhsiang.github.io/tags/Microsoft-Entra-ID/">Microsoft Entra ID</a>
    
    <a href="https://beanhsiang.github.io/tags/ML.NET/">ML.NET</a>
    
    <a href="https://beanhsiang.github.io/tags/MLX/">MLX</a>
    
    <a href="https://beanhsiang.github.io/tags/Model-Context-Protocol/">Model Context Protocol</a>
    
    <a href="https://beanhsiang.github.io/tags/Model-Based/">Model-Based</a>
    
    <a href="https://beanhsiang.github.io/tags/Multi-Agent/">Multi-Agent</a>
    
    <a href="https://beanhsiang.github.io/tags/Phi-3/">Phi-3</a>
    
    <a href="https://beanhsiang.github.io/tags/Phi-4/">Phi-4</a>
    
    <a href="https://beanhsiang.github.io/tags/PydanticAI/">PydanticAI</a>
    
    <a href="https://beanhsiang.github.io/tags/RAFT/">RAFT</a>
    
    <a href="https://beanhsiang.github.io/tags/RAG/">RAG</a>
    
    <a href="https://beanhsiang.github.io/tags/Real-Time-API/">Real-Time API</a>
    
    <a href="https://beanhsiang.github.io/tags/Semantic-Kernel/">Semantic Kernel</a>
    
    <a href="https://beanhsiang.github.io/tags/VoiceRAG/">VoiceRAG</a>
    
    <a href="https://beanhsiang.github.io/tags/%E7%A9%BF%E8%B6%8A%E4%BA%BA%E6%9C%BA%E8%9E%8D%E5%90%88%E4%B9%8B%E9%99%85/">穿越人机融合之际</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://fireusergroup.com/" title="FireUG">FireUG 技术社区</a>
        </li>
        
        <li>
            <a target="_blank" href="https://space.bilibili.com/545713776" title="FireUG 技术社区 - B 站">FireUG 技术社区 - B 站</a>
        </li>
        
        <li>
            <a target="_blank" href="https://www.douyin.com/user/MS4wLjABAAAAYGG_Q3--hpBKc7rq2h-slFNFObDCmrxYc8OF2tl_mV4" title="火油鸡">火油鸡</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://beanhsiang.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>